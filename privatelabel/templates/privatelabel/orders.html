{% extends "privatelabel/tabs_nav.html" %}
{% load crispy_forms_tags %}
{% block content %}
<style>
    .flex-container {
        display: flex;
        align-items:center;
        justify-content: space-between;
    }
    
</style>


<div class="flex-container">
    <input type="text" id="searchBox" class="form-control text-center" placeholder="Search Record" style="width: 33%;" oninput="filter()">
    {% if user.is_authenticated %}
        <a href="{% url 'privatelabel-new_order' %}" class="btn btn-outline-primary">Create Order</a>
    {% endif %}
 </div>

 

<table class="table mt-5 table-hover">
    <thead>
        <tr>
            <th>Customer</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Date Received</th>
            <th>Due Date</th>
            <th>Progress</th>
            <th>Next Step</th>
            <th>Take Action</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
            <tr class="item" style="cursor: pointer;" data-toggle="modal"  data-target="#orderModal{{ order.id }}">
                <td>{{ order.customer.name }}</td>
                <td>{{ order.product.name }}</td>
                <td>{{ order.qty }}</td>
                <td>{{ order.date_received|timesince:"" }} ago</td>
                <td>
                    {{ order.due_date}}
                     <br> <small style="color: red;">{{ order.due_date|timesince:"" }} ago</small>
                </td>
                <td>
                    <div class="progress" style="width: 100%;">
                        <div class="progress-bar bg-success text-center" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:{{ order.progress}}%">
                          {{ order.progress }}%
                        </div>
                    </div>
                </td>
                <td>{{ order.status }}</td>
                <td>{{ order.take_action_user.first_name }}</td>
                
            </tr>

            <!-- Modal -->
            <div class="modal fade"  id="orderModal{{ order.id }}" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel{{ order.id }}" aria-hidden="true">
                <div class="modal-dialog" style="max-width: 800px;" role="document">
                    <div class="modal-content"  >
                        <div class="modal-header">
                            <h5 class="modal-title" id="orderModalLabel{{ order.id }}">Order Details - {{ order.id }}</h5>
                            
                            <p class="mt-1 ml-1"><small>Last Updated: {{ order.last_updated }}</small></p>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        
                        
                        
                            <!-- use orderForm -->
                            <form method="POST" action="{% url 'privatelabel-order' order.id %}" enctype="multipart/form-data">
                                <div class="modal-body rounded p-4 m-4" style="background-color: rgb(243, 241, 241);">
                                {% csrf_token %}

                                <div class="m-2 flex-container">
                                    <div class="form-group">
                                        <label for="order.product.name">Product</label>
                                        <input type="text" style="width: 400px" class="form-control" id="order.product.name" name="order.product.name" value="{{ order.product.name }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.qty">Quantity</label>
                                        <input type="number" class="form-control" id="order.qty" name="order.qty" value="{{ order.qty }}">
                                    </div>
                                </div>
                                
                                
                                <div class="form-group">
                                    <div class="d-flex justify-content-around" style="background-color: #555657; border-radius: 10px; padding: 10px;">
                                        <!-- Deposit -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.deposit_stat_{{ order.id }}" name="order.deposit_stat" value="{{ order.deposit_stat }}" {% if order.deposit_stat %}checked{% endif %} onchange="toggleIcon(this, 'deposit-icon-{{ order.id }}')" style="display: none;" data-icon-id="deposit-icon-{{ order.id }}">
                                            <label class="form-check-label" for="order.deposit_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="deposit-icon-{{ order.id }}" class="fa-solid fa-sack-dollar fa-xl {% if order.deposit_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Deposit</div>
                                            </label>
                                        </div>

                                        <!-- Ingredients -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.ingredients_stat_{{ order.id }}" name="order.ingredients_stat" value="{{ order.ingredients_stat }}" {% if order.ingredients_stat %}checked{% endif %} onchange="toggleIcon(this, 'ingredients-icon-{{order.id}}')" style="display: none;" data-icon-id="ingredients-icon-{{ order.id }}">
                                            <label class="form-check-label" for="order.ingredients_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="ingredients-icon-{{order.id}}" class="fa-solid fa-flask fa-xl {% if order.ingredients_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Ingredients</div>
                                            </label>
                                        </div>

                                        <!-- Spec -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.spec_stat_{{ order.id }}" name="order.spec_stat" value="{{ order.spec_stat }}" {% if order.spec_stat %}checked{% endif %} onchange="toggleIcon(this, 'spec-icon-{{order.id}}')" style="display: none;" data-icon-id="spec-icon-{{order.id}}">
                                            <label class="form-check-label" for="order.spec_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="spec-icon-{{order.id}}" class="fa-solid fa-file-lines fa-xl {% if order.spec_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Spec</div>
                                            </label>
                                        </div>

                                        <!-- Package -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.package_stat_{{ order.id }}" name="order.package_stat" value="{{ order.package_stat }}" {% if order.package_stat %}checked{% endif %} onchange="toggleIcon(this, 'package-icon-{{order.id}}')" style="display: none;" data-icon-id="package-icon-{{order.id}}">
                                            <label class="form-check-label" for="order.package_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="package-icon-{{order.id}}" class="fa-solid fa-bottle-water fa-xl {% if order.package_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Package</div>
                                            </label>
                                        </div>

                                        <!-- Cap -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.cap_stat_{{ order.id }}" name="order.cap_stat" value="{{ order.cap_stat }}" {% if order.cap_stat %}checked{% endif %} onchange="toggleIcon(this, 'cap-icon-{{order.id}}')" style="display: none;" data-icon-id="cap-icon-{{order.id}}">
                                            <label class="form-check-label" for="order.cap_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="cap-icon-{{order.id}}" class="fa-brands fa-bitbucket fa-rotate-180 fa-xl {% if order.cap_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Cap</div>
                                            </label>
                                        </div>

                                        <!-- Label -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.label_stat_{{ order.id }}" name="order.label_stat" value="{{ order.label_stat }}" {% if order.label_stat %}checked{% endif %} onchange="toggleIcon(this, 'label-icon-{{order.id}}')" style="display: none;" data-icon-id="label-icon-{{order.id}}">
                                            <label class="form-check-label" for="order.label_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="label-icon-{{order.id}}" class="fa-regular fa-image fa-xl {% if order.label_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Label</div>
                                            </label>
                                        </div>

                                        <!-- Box -->
                                        <div class="text-center">
                                            <input class="form-check-input" type="checkbox" id="order.box_stat_{{ order.id }}" name="order.box_stat" value="{{ order.box_stat }}" {% if order.box_stat %}checked{% endif %} onchange="toggleIcon(this, 'box-icon-{{order.id}}')" style="display: none;" data-icon-id="box-icon-{{order.id}}">
                                            <label class="form-check-label" for="order.box_stat_{{ order.id }}" style="cursor: pointer;">
                                                <i id="box-icon-{{order.id}}" class="fa-solid fa-box fa-xl {% if order.box_stat %}text-success{% else %}text-muted{% endif %}"></i>
                                                <div class="text-white">Box</div>
                                            </label>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                                
                                <!-- add an input for the expected to ship date -->
                                <div class="m-2 flex-container">
                                    <div class="form-group">
                                        <label for="order.date_received">Date Received</label>
                                        <input type="date" class="form-control" id="order.date_received" name="order.date_received" value="{{ order.date_received|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.due_date">Due Date</label>
                                        <input type="date" class="form-control" id="order.due_date" name="order.due_date" value="{{ order.due_date|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.last_component_eta">Last Component Date</label>
                                        <input type="date" class="form-control" id="order.last_component_eta" name="order.last_component_eta" value="{{ order.last_component_eta|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.expected_ship_date">Expected Ship Date</label>
                                        <input type="date" class="form-control" id="order.expected_ship_date" name="order.expected_ship_date" value="{{ order.expected_ship_date|date:'Y-m-d' }}">
                                    </div>
                                </div>
                                <div class="m-2 d-flex justify-content-around">
                                    <div>
                                        <label for="order.status">Next Step</label>
                                        <!-- drop down -->
                                        <select class="form-control" id="order.status" name="order.status">
                                            <option value="Deposit" {% if order.status == "Deposit" %}selected{% endif %}>Deposit</option>
                                            <option value="Ingredients" {% if order.status == "Ingredients" %}selected{% endif %}>Ingredients</option>
                                            <option value="Spec" {% if order.status == "Spec" %}selected{% endif %}>Spec</option>
                                            <option value="Package" {% if order.status == "Package" %}selected{% endif %}>Package</option>
                                            <option value="Cap" {% if order.status == "Cap" %}selected{% endif %}>Cap</option>
                                            <option value="Label" {% if order.status == "Label" %}selected{% endif %}>Label</option>
                                            <option value="Box" {% if order.status == "Box" %}selected{% endif %}>Box</option>
                                            <option value="Complete" {% if order.status == "Complete" %}selected{% endif %}>Complete</option>
                                        </select>
                                    </div>
                                    <div>
                                        <Label for="order.take_action_user">Take Action</Label>
                                        <!-- drop down -->
                                        <select class="form-control" id="order.take_action_user" name="order.take_action_user">
                                            <option value="Gregg" {% if order.take_action_user.first_name == "Gregg" %}selected{% endif %}>Gregg</option>
                                            <option value="Liz" {% if order.take_action_user.first_name == "Liz" %}selected{% endif %}>Liz</option>
                                            <option value="Rosa" {% if order.take_action_user.first_name == "Rosa" %}selected{% endif %}>Rosa</option>
                                        </select>
                                    </div>
                                    
                                    
                                </div>
                                <div class="m-2 flex-container">
                                    <div class="form-group">
                                        <label for="order.customer_po"><i class="fa-solid fa-file-invoice"></i> CPO</label>
                                        <input type="file" class="form-control-file" id="order.customer_po" name="order.customer_po" hidden>
                                        {% if order.customer_po %}
                                            <br><a href="{{ order.customer_po.url }}" target="_blank" class="btn btn-link"><i class="fa-solid fa-eye"></i> View File</a>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="order.quality_agreement"><i class="fa-solid fa-file-contract"></i> QA</label>
                                        <input type="file" class="form-control-file" id="order.quality_agreement" name="order.quality_agreement" hidden>
                                        {% if order.quality_agreement %}
                                            <br><a href="{{ order.quality_agreement.url }}" target="_blank" class="btn btn-link"><i class="fa-solid fa-eye"></i> View File</a>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="order.terms_and_conditions"><i class="fa-solid fa-file-signature"></i> T&C</label>
                                        <input type="file" class="form-control-file" id="order.terms_and_conditions" name="order.terms_and_conditions" hidden>
                                        {% if order.terms_and_conditions %}
                                            <br><a href="{{ order.terms_and_conditions.url }}" target="_blank" class="btn btn-link"><i class="fa-solid fa-eye"></i> View File</a>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="order.official_quote"><i class="fa-solid fa-file-invoice-dollar"></i> OQ</label>
                                            <br><input type="file" class="form-control-file" id="order.official_quote" name="order.official_quote" hidden>
                                        {% if order.official_quote %}
                                            <a href="{{ order.official_quote.url }}" target="_blank" class="btn btn-link"><i class="fa-solid fa-eye"></i> View File</a>
                                        {% endif %}
                                    </div>
                                </div>

                                
                                
                                <div>
                                    <button type="submit" class="mt-2 btn btn-primary">Update</button>
                                </div>
                            <!-- Add more details as needed -->
                            </div>
                            
                            <!-- add a gray line -->
                            <hr>

                            <!-- Notes Section -->
                             
                            <div class="mb-2 container">
                                <div class="row">
                                    <!-- Add Note Section -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="new-note">Add Note</label>
                                            <textarea class="form-control" id="new-note-{{order.id}}" style="width: 100%;" rows="2"></textarea>
                                        </div>
                                        <button type="button" class="btn btn-secondary btn-sm" id="add-note-button-{{order.id}}">Post</button>
                                    </div>
                                    <!-- Notes Section -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label style="text-decoration: underline;">Notes</label>
                                                <ul id="notes-list-{{order.id}}" style="max-height: 200px; overflow-y: auto">
                                                    {% for note in order.notes.all reversed %}
                                                        <li><strong>{{ note.content }}</strong> </br> <small>{{ note.date }}</small></li>
                                                    {% endfor %}
                                          
                                                </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.getElementById('add-note-button-{{order.id}}').addEventListener('click', function() {
                                    
                                    const noteContent = document.getElementById('new-note-{{order.id}}').value;
                                    const csrfToken = '{{ csrf_token }}';  // Ensure CSRF token is included in the request
                            
                                    if (noteContent.trim()) {
                                        fetch("{% url 'privatelabel-add-note' order.id %}", {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrfToken  // CSRF token for Django
                                            },
                                            body: JSON.stringify({
                                                content: noteContent
                                            })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                const newNoteElement = document.createElement('li');
                                                newNoteElement.innerHTML = `${data.note.content} </br> <small>Now</small>`;
                                                const notesList = document.getElementById('notes-list-{{order.id}}');
                                                notesList.insertBefore(newNoteElement, notesList.firstChild);
                            
                                                // Clear the note input field
                                                document.getElementById('new-note-{{order.id}}').value = '';
                                            } else {
                                                alert('Failed to add note.');
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error adding note:', error);
                                            alert('An error occurred.');
                                        });
                                    } else {
                                        alert('Note cannot be empty.');
                                    }
                                });
                            
                            </script>
                            
                        
                    </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </tbody>
</table>
 
<script src="https://kit.fontawesome.com/4c72223fdf.js" crossorigin="anonymous"></script>
 <script>
    function filter() {
    var input = document.getElementById("searchBox");
    var filter = input.value.toUpperCase().trim();
    var items = document.getElementsByClassName("item");
    let firstVisibleitem = null;

    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var itemText = item.innerText.toUpperCase().trim();

        if (itemText.indexOf(filter) > -1) {
            item.style.display = "";
            if (!firstVisibleitem) {
                firstVisibleitem = item;
            }
        } else {
            item.style.display = "none";
        }
    }

}
</script>
<script>
    function toggleIcon(checkbox, iconId) {
    console.log('Checkbox ID:', checkbox.id);
    console.log('Icon ID:', iconId);
    const icon = document.getElementById(iconId);
    if (icon) { // Check if the icon exists
        if (checkbox.checked) {
            icon.classList.remove("text-muted");
            icon.classList.add("text-success");
        } else {
            icon.classList.remove("text-success");
            icon.classList.add("text-muted");
        }
    } else {
        console.warn(`Icon with ID "${iconId}" not found.`);
    }
}
</script>




{% endblock content %}