{% extends "privatelabel/tabs_nav.html" %}
{% load crispy_forms_tags %}
{% block content %}
<style>
    .flex-container {
        display: flex;
        align-items:center;
        justify-content: space-between;
    }
    
</style>


<div class="flex-container">
    <input type="text" id="searchBox" class="form-control text-center" placeholder="Search Record" style="width: 33%;" oninput="filter()">
    {% if user.is_authenticated %}
        <a href="{% url 'privatelabel-new_order' %}" class="btn btn-outline-primary">Create Order</a>
    {% endif %}
 </div>

 

<table class="table mt-5 table-hover">
    <thead>
        <tr>
            <th>Customer</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Date Received</th>
            <th>Due Date</th>
            <th>Progress</th>
            <th>Next Step</th>
            <th>Take Action</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
            <tr class="item" style="cursor: pointer;" data-toggle="modal"  data-target="#orderModal{{ order.id }}">
                <td>{{ order.customer.name }}</td>
                <td>{{ order.product.name }}</td>
                <td>{{ order.qty }}</td>
                <td>{{ order.date_received|timesince:"" }} ago</td>
                <td>
                    {% if order.due_date > now %}
                        In {{ order.due_date|timeuntil:"" }}
                    {% else %}
                        <span style="color: red;">{{ order.due_date|timesince:"" }} ago</span>
                    {% endif %}
                </td>
                <td>
                    <div class="progress" style="width: 100%;">
                        <div class="progress-bar bg-success text-center" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:{{ order.progress}}%">
                          {{ order.progress }}%
                        </div>
                    </div>
                </td>
                <td>{{ order.status }}</td>
                <td>{{ order.take_action_user }}</td>
                
            </tr>

            <!-- Modal -->
            <div class="modal fade"  id="orderModal{{ order.id }}" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel{{ order.id }}" aria-hidden="true">
                <div class="modal-dialog" style="max-width: 800px;" role="document">
                    <div class="modal-content" >
                        <div class="modal-header">
                            <h5 class="modal-title" id="orderModalLabel{{ order.id }}">Order Details - {{ order.id }}</h5>
                            
                            <p class="mt-1 ml-1"><small>Last Updated: {{ order.last_updated }}</small></p>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        
                        
                        
                            <!-- use orderForm -->
                            <form method="POST" action="{% url 'privatelabel-order' order.id %}">
                                <div class="modal-body">
                                {% csrf_token %}

                                <div class="flex-container">
                                    <div class="form-group">
                                        <label for="order.product.name">Product</label>
                                        <input type="text" style="width: 400px" class="form-control" id="order.product.name" name="order.product.name" value="{{ order.product.name }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.qty">Quantity</label>
                                        <input type="number" class="form-control" id="order.qty" name="order.qty" value="{{ order.qty }}">
                                    </div>
                                </div>
                                <!-- add an input for the expected to ship date -->
                                <div class="flex-container">
                                    <div class="form-group">
                                        <label for="order.date_received">Date Received</label>
                                        <input type="date" class="form-control" id="order.date_received" name="order.date_received" value="{{ order.date_received|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.due_date">Due Date</label>
                                        <input type="date" class="form-control" id="order.due_date" name="order.due_date" value="{{ order.due_date|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.last_component_eta">Last Component Date</label>
                                        <input type="date" class="form-control" id="order.last_component_eta" name="order.last_component_eta" value="{{ order.last_component_eta|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="order.expected_ship_date">Expected Ship Date</label>
                                        <input type="date" class="form-control" id="order.expected_ship_date" name="order.expected_ship_date" value="{{ order.expected_ship_date|date:'Y-m-d' }}">
                                    </div>
                                </div>
                                
                                
                                <div class="form-group">
                                    <div class="d-flex justify-content-between">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.deposit_stat" name="order.deposit_stat" value="{{order.deposit_stat}}" {% if order.deposit_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.deposit_stat">Deposit</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.ingredients_stat" name="order.ingredients_stat" value={{order.ingredients_stat}} {% if order.ingredients_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.ingredients_stat">Ingredients</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.spec_stat" name="order.spec_stat" value={{order.spec_stat}} {% if order.spec_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.spec_stat">Spec</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.package_stat" name="order.package_stat" value={{order.package_stat}} {% if order.package_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.package_stat">Package</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.cap_stat" name="order.cap_stat" value={{order.cap_stat}} {% if order.cap_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.cap_stat">Cap</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.label_stat" name="order.label_stat" value={{order.label_stat}} {% if order.label_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.label_stat">Label</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="order.box_stat" name="order.box_stat" value={{order.box_stat}} {% if order.box_stat %}checked{% endif %}>
                                            <label class="form-check-label" for="order.box_stat">Box</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <label for="order.status">Next Step</label>
                                    <!-- drop down -->
                                    <select class="form-control" id="order.status" name="order.status">
                                        <option value="Deposit">Deposit</option>
                                        <option value="Ingredients">Ingredients</option>
                                        <option value="Spec">Spec</option>
                                        <option value="Package">Package</option>
                                        <option value="Cap">Cap</option>
                                        <option value="Label">Label</option>
                                        <option value="Box">Box</option>
                                        <option value="Complete">Complete</option>
                                    </select>
                                    <Label for="order.take_action_user">Take Action</Label>
                                    <!-- drop down -->
                                    <select class="form-control" id="order.take_action_user" name="order.take_action_user">
                                        <option value="Gregg">Gregg</option>
                                        <option value="Liz">Liz</option>
                                        <option value="Rosa">Rosa</option>
                                    </select>
                                    
                                </div>
                                
                                
                                <div>
                                    <button type="submit" class="btn btn-primary">Update</button>
                                </div>
                            <!-- Add more details as needed -->
                            </div>
                            
                            <!-- add a gray line -->
                            <hr>

                            <!-- Notes Section -->
                             
                            <div class="mb-2 container">
                                <div class="row">
                                    <!-- Notes Section -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label style="text-decoration: underline;">Notes</label>
                                                <ul id="notes-list-{{order.id}}" style="max-height: 200px; overflow-y: auto">
                                                    {% for note in order.notes.all reversed %}
                                                        <li><strong>{{ note.content }}</strong> </br> <small>{{ note.date }}</small></li>
                                                    {% endfor %}
                                          
                                                </ul>
                                        </div>
                                    </div>
                                    <!-- Add Note Section -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="new-note">Add Note</label>
                                            <textarea class="form-control" id="new-note-{{order.id}}" style="width: 100%;" rows="2"></textarea>
                                        </div>
                                        <button type="button" class="btn btn-secondary btn-sm" id="add-note-button-{{order.id}}">Add Note</button>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.getElementById('add-note-button-{{order.id}}').addEventListener('click', function() {
                                    
                                    const noteContent = document.getElementById('new-note-{{order.id}}').value;
                                    const csrfToken = '{{ csrf_token }}';  // Ensure CSRF token is included in the request
                            
                                    if (noteContent.trim()) {
                                        fetch("{% url 'privatelabel-add-note' order.id %}", {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrfToken  // CSRF token for Django
                                            },
                                            body: JSON.stringify({
                                                content: noteContent
                                            })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                const newNoteElement = document.createElement('li');
                                                newNoteElement.innerHTML = `${data.note.content} </br> <small>Now</small>`;
                                                const notesList = document.getElementById('notes-list-{{order.id}}');
                                                notesList.insertBefore(newNoteElement, notesList.firstChild);
                            
                                                // Clear the note input field
                                                document.getElementById('new-note-{{order.id}}').value = '';
                                            } else {
                                                alert('Failed to add note.');
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error adding note:', error);
                                            alert('An error occurred.');
                                        });
                                    } else {
                                        alert('Note cannot be empty.');
                                    }
                                });
                            
                            </script>
                            
                        
                    </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </tbody>
</table>
 
    
 <script>
    function filter() {
    var input = document.getElementById("searchBox");
    var filter = input.value.toUpperCase().trim();
    var items = document.getElementsByClassName("item");
    let firstVisibleitem = null;

    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var itemText = item.innerText.toUpperCase().trim();

        if (itemText.indexOf(filter) > -1) {
            item.style.display = "";
            if (!firstVisibleitem) {
                firstVisibleitem = item;
            }
        } else {
            item.style.display = "none";
        }
    }

    // Trigger click on the first visible item after filtering
    if (firstVisibleitem) {
        firstVisibleitem.querySelector('.workorder-item').click();
    }
}
</script>




{% endblock content %}